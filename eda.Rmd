---
title: Statistics 149 Final Project EDA
output: pdf_document
---

```{r setup, echo=FALSE}

knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE,
                      echo = TRUE)

# loading packages

library(tidyverse)
library(janitor)
library(skimr)
library(heatmaply)
library(ggfortify)
library(arm)

# getting the data in

nba <- read_csv('nba_5year_surv.csv')  %>% 
  clean_names() %>% 
  mutate(surv_5yrs = ifelse(surv_5yrs=='Yes', 1, 0))

```

There is almost no missing data, with `t3p_percent` only missing 10 observations of 1328 total. None of the other variables are missing data.

There are 22 duplicated names in the data. Some names, like Bob Martin, only have two observations and are common names. However, it is worth investigating whether or not these players are not repeated observations. Were there truly 6 unique Charles Smiths, 4 unique Dee Browns, and 2 unique Tim Hardaways?

It appears that those with missing 3pt data all have 0 for `t3p_attempts_per_game`, which indicates that it's possible that these 10 players never attempted a 3 pt shot. Upon further inspection, however, many more players than 10 players have zero `t3p_attempts_per_game`. Because this metric is a per-game average, it's likely that these players without missing data did attempt very few three point shots, especially since some of these players with zero attempts per game have three point percentages of 100, 50, 33.33, 25, and 0.

```{r summary_stats}

# making sure there isn't anything wonky with our dataset

skim(nba)

# checking out what the repeated names are

nba %>% 
  count(name) %>% 
  filter(n > 1)

# looking at the observations with missing data for t3p_percent

# it appears that those with missing 3pt data all have 0 for
# t3p_attempts_per_game, which indicates that it's possible that these 10
# players never attempted a 3 pt shot

nba %>% 
  filter(is.na(t3p_percent)) %>% 
  select(name, games_played, t3p_attempts_per_game, t3p_percent)

# there are many more players to have 0 t3p_attempts_per_game though... since
# it's a per-game average, it's possible that these players did attempt 1 or a
# very small number of three pt shots such that it averaged out to 0 across all
# games (especially since some of these players with 0 attempts per game have
# t3p_percent of 100, 50, 33.33, 25, and 0)

nba %>% 
  filter(t3p_attempts_per_game == 0) %>% 
  arrange(desc(t3p_percent)) %>% 
  select(name, games_played, t3p_attempts_per_game, t3p_percent)

```
I want to see which variables are highly correlated (dropping NAs for now, but come back and fix later):

```{r corr_map}

# making a correlation heatmap

nba %>% 
  mutate(surv_5yrs = ifelse(surv_5yrs=='Yes', 1, 0)) %>% 
  select(-name) %>% 
  cor(use = 'complete.obs')  %>% 
  heatmaply_cor(xlab = "Features",
              ylab = "Features",
              k_col = 2,
              k_row = 2,
              show_dendrogram = FALSE)

# checking the most correlated variables

nba %>% 
  select(-name) %>% 
  cor(use = 'complete.obs') %>% 
  as.data.frame() %>% 
  rownames_to_column('var1') %>% 
  pivot_longer(games_played:ncol(.), names_to = 'var2', values_to = 'cor') %>% 
  filter(var1 != var2) %>% 
  arrange(desc(cor))

```

```{r clustering}

# producing a PCA plot to see if there is any interesting clustering... as
# expected, players that survive tend to have higher metrics across all
# categories

# (note that this whole code chunk is drawn from
# https://cran.r-project.org/web/packages/ggfortify/vignettes/plot_pca.html)

pca_res <- prcomp(drop_na(select(nba, -name)), scale. = TRUE)
autoplot(pca_res, colour = 'surv_5yrs',
         loadings = TRUE, loadings.colour = 'blue',
         loadings.label = TRUE, loadings.label.size = 3)

# also trying k-means clustering... mainly picks up cluster 2 as the ones that
# last the longest, but there is a fair number of observations mis-clustered in
# cluster 1 (likely those who survived but had low metrics?)

autoplot(fanny(drop_na(select(nba, -name)), 2), frame = TRUE)
autoplot(silhouette(pam(select(nba, -name), 2L)))

```

```{r variable_histograms}

# plotting histograms of all of our variables... want to fill by `surv_5yrs`,
# but I can't get that code to work right now

nba %>% 
  pivot_longer(games_played:turnovers_per_game, names_to = 'variables', values_to = 'values') %>% 
  ggplot(aes(values, color = surv_5yrs)) +
  geom_histogram() +
  facet_wrap(~variables, scales = 'free')

```

```{r stepwise_cv}

# performing stepwise variable selection, as outlined here
# http://www.sthda.com/english/articles/36-classification-methods-essentials/150-stepwise-logistic-regression-essentials-in-r/#computing-stepwise-logistique-regression

library(MASS)
select <- dplyr::select

model.dat <- nba %>% select(-name) %>% drop_na()
full.model <- glm(surv_5yrs ~ ., 
                  data = model.dat,
                  family = binomial)
step.model <- full.model %>% stepAIC(trace = FALSE)
summary(step.model)

# deviance / df is close to 1

step.model$deviance / step.model$df.residual

# cook's distances

{
  plot(cooks.distance(step.model), type="h", lwd=2,
        xlab="Observation index",
        ylab="Cook's distances",
        main="Cook's distances for backward stepwise regression")
  abline(h=1,lty=2,col="red")
}

# looking at the deviance plot... looks good

binnedplot(fitted(step.model), residuals(step.model, type="response"),
  xlab="Averaged fitted probabilities",
  ylab="Averaged residuals",
  pch=19, col.pts="red", cex.pts=1.5,
  main="Fitted vs residual plot for model from part (c)")
abline(h=0,lty=2,col="green")

summary(step.model)

interact.3pt <- glm(surv_5yrs ~ games_played + min_per_game + fg_attempts_per_game + 
    fg_percent + t3p_made_per_game * t3p_attempts_per_game + 
    ft_percent + oreb_per_game + assists_per_game + blocked_shots_per_game, 
    data = model.dat, family = binomial)
anova(step.model, interact.3pt)

# incorrectly predicts KAT, but that's because he is an allstar who just hadn't
# been in the league for 5 years at the time of data collection

predict(step.model, filter(nba, name %in% c('Karl-Anthony Towns', 
                                            'LeBron James')), 
        type = 'response')


```
